<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudKlone - Cloud Storage Management</title>
    <link rel="icon" type="image/png" href="/logo.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #252525;
            --text-primary: #e8e8e8;
            --text-secondary: #a0a0a0;
            --text-tertiary: #707070;
            --accent-orange: #B497D6;
            --accent-orange-hover: #C5AAE3;
            --border-color: #2a2a2a;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
        }
        
        /* Light Mode Theme */
        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e8e8e8;
            --text-primary: #1a1a1a;
            --text-secondary: #4a4a4a;
            --text-tertiary: #707070;
            --border-color: #d0d0d0;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }
        
        /* Auth Screen */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .auth-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 3rem;
            width: 100%;
            max-width: 400px;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .logo-container img {
            width: 48px;
            height: 48px;
            border-radius: 8px;
        }
        
        .logo-container h1 {
            font-size: 32px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.8px;
        }
        
        /* Main Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 240px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 2rem 0;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 0 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .sidebar-header img {
            width: 32px;
            height: 32px;
            border-radius: 6px;
        }
        
        .sidebar-header h1 {
            font-size: 20px;
            font-weight: 600;
            letter-spacing: -0.4px;
        }
        
        .sidebar-nav {
            flex: 1;
            padding: 1.5rem 0.75rem;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 0.75rem;
            margin-bottom: 0.25rem;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 14px;
            font-weight: 500;
        }
        
        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .nav-item.active {
            background: var(--accent-orange);
            color: white;
        }
        
        .sidebar-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        
        .main-content {
            flex: 1;
            overflow-y: auto;
        }
        
        .content-header {
            padding: 2rem 3rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .content-header h2 {
            font-size: 28px;
            font-weight: 600;
            letter-spacing: -0.7px;
            margin-bottom: 0.5rem;
        }
        
        .content-header p {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .content-body {
            padding: 2rem 3rem;
            max-width: 1400px;
        }
        
        /* Cards */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 1.25rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            transition: all 0.15s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-orange);
            background: var(--bg-secondary);
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
        }
        
        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            background: var(--accent-orange);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s ease;
            font-family: inherit;
        }
        
        .btn:hover:not(:disabled) {
            background: var(--accent-orange-hover);
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: var(--bg-secondary);
        }
        
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 13px;
        }
        
        .btn-danger {
            background: var(--error);
        }
        
        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
        }
        
        /* Transfer Items */
        .transfer-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.15s ease;
        }
        
        .transfer-item:hover {
            border-color: var(--accent-orange);
        }
        
        .transfer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .transfer-status {
            display: inline-flex;
            align-items: center;
            padding: 0.35rem 0.75rem;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .transfer-status.running {
            background: rgba(255, 107, 53, 0.15);
            color: var(--accent-orange);
        }
        
        .transfer-status.scheduled {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }
        
        .transfer-status.completed {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }
        
        .transfer-status.failed {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
        }
        
        .transfer-path {
            font-size: 13px;
            color: var(--text-secondary);
            font-family: 'Monaco', monospace;
            margin: 0.75rem 0;
        }
        
        .transfer-arrow {
            color: var(--accent-orange);
            margin: 0 0.5rem;
        }
        
        .progress-bar {
            height: 4px;
            background: var(--bg-primary);
            border-radius: 2px;
            overflow: hidden;
            margin: 1rem 0 0.75rem;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-orange), var(--accent-orange-hover));
            transition: width 0.3s ease;
        }
        
        .transfer-stats {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-tertiary);
            font-family: 'Monaco', monospace;
        }
        
        .transfer-stats strong {
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .transfer-error {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid var(--error);
            border-radius: 4px;
            font-size: 13px;
            color: var(--error);
        }
        
        /* Remote Items */
        .remote-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            transition: all 0.15s ease;
        }
        
        .remote-item:hover {
            border-color: var(--accent-orange);
        }
        
        .remote-info h4 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .remote-info p {
            font-size: 13px;
            color: var(--text-tertiary);
        }
        
        .remote-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1.5rem;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--accent-orange);
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            font-size: 13px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Grid Layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        
        /* Utilities */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .mt-2 { margin-top: 1rem; }
        
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            vertical-align: middle;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-tertiary);
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .content-header, .content-body {
                padding: 1.5rem;
            }
            
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="auth-section" class="auth-container">
        <div class="auth-card">
            <div class="logo-container">
                <img src="/logo.png" alt="CloudKlone Logo">
                <h1>CloudKlone</h1>
            </div>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="username" value="admin" autocomplete="username">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="password" value="admin" autocomplete="current-password">
            </div>
            <button class="btn" onclick="login()" style="width: 100%; margin-top: 0.5rem;">Sign In</button>
            <p id="login-error" style="color: var(--error); margin-top: 1rem; text-align: center; font-size: 13px;"></p>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-section" class="app-container hidden">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="/logo.png" alt="CloudKlone Logo">
                <h1>CloudKlone</h1>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-item active" onclick="showTab('transfers')">Transfers</div>
                <div class="nav-item" onclick="showTab('history')">History</div>
                <div class="nav-item" onclick="showTab('scheduled')">Scheduled</div>
                <div class="nav-item" onclick="showTab('tests')">Tests & Queries</div>
                <div class="nav-item" onclick="showTab('decrypt')">Decrypt</div>
                <div id="remotes-nav" class="nav-item" onclick="showTab('remotes')">Remotes</div>
                <div id="settings-nav" class="nav-item" onclick="showTab('settings')">Settings</div>
                <div id="admin-nav" class="nav-item hidden" onclick="showTab('admin')">Admin</div>
                <div class="nav-item" onclick="showTab('logs')">Logs</div>
            </nav>
            <div class="sidebar-footer">
                <button class="btn btn-small" onclick="toggleTheme()" style="width: 100%; margin-bottom: 0.5rem;" id="theme-toggle-btn">
                    üåô Dark Mode
                </button>
                <button class="btn btn-secondary btn-small" onclick="logout()" style="width: 100%;">Logout</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Transfers Tab -->
            <div id="tab-transfers" class="tab-content">
                <div class="content-header">
                    <h2>Transfers</h2>
                    <p>Create and monitor cloud and local transfers</p>
                </div>
                <div class="content-body">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">New Transfer</div>
                        </div>
                        <div class="form-group">
                            <label>Operation</label>
                            <select id="operation">
                                <option value="copy">Copy (preserve source)</option>
                                <option value="sync">Sync (mirror to destination)</option>
                            </select>
                        </div>
                        
                        <div class="card" style="background: var(--bg-tertiary); padding: 1rem; margin-bottom: 1.5rem;">
                            <div class="form-group" style="margin-bottom: 0.75rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="schedule-enabled" style="width: auto;" onchange="toggleSchedule()">
                                    Schedule this transfer
                                </label>
                            </div>
                            <div id="schedule-options" class="hidden">
                                <div class="form-group">
                                    <label>Schedule Type</label>
                                    <select id="schedule-type" onchange="toggleScheduleType()">
                                        <option value="once">Run once at specific time</option>
                                        <option value="recurring">Run on repeat</option>
                                    </select>
                                </div>
                                <div id="schedule-once">
                                    <div class="form-group">
                                        <label>Date & Time</label>
                                        <input type="datetime-local" id="schedule-datetime">
                                    </div>
                                </div>
                                <div id="schedule-recurring" class="hidden">
                                    <div class="form-group">
                                        <label>Repeat Interval</label>
                                        <select id="schedule-interval">
                                            <option value="hourly">Every hour</option>
                                            <option value="daily">Every day</option>
                                            <option value="weekly">Every week</option>
                                            <option value="monthly">Every month</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Start Time (for daily/weekly/monthly)</label>
                                        <input type="time" id="schedule-time" value="00:00">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card" style="background: var(--bg-tertiary); padding: 1rem; margin-bottom: 1.5rem;">
                            <div class="form-group" style="margin-bottom: 0.75rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="encrypt-enabled" style="width: auto;" onchange="toggleEncryption()">
                                    Encrypt this transfer
                                </label>
                            </div>
                            <div id="encryption-options" class="hidden">
                                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 1rem;">
                                    Files will be encrypted using rclone crypt before being transferred to the destination. You'll need the password to decrypt them later.
                                </p>
                                <div class="form-group">
                                    <label>Encryption Password (optional - auto-generated if empty)</label>
                                    <input type="password" id="encrypt-password" placeholder="Leave blank for auto-generated password">
                                </div>
                                <div class="form-group">
                                    <label>Confirm Password</label>
                                    <input type="password" id="encrypt-password-confirm" placeholder="Confirm password">
                                </div>
                                <div style="padding: 0.75rem; background: rgba(var(--warning-rgb), 0.1); border-left: 3px solid var(--warning); border-radius: 4px; font-size: 13px; color: var(--text-secondary);">
                                    ‚ö†Ô∏è <strong>Important:</strong> Save your encryption password! Without it, you cannot decrypt your files. Encrypted transfers will be marked with [ENCRYPTED] in logs.
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid-2">
                            <div>
                                <h4 style="margin-bottom: 1rem; font-size: 14px; color: var(--text-secondary);">Source</h4>
                                <div class="form-group">
                                    <label>Remote</label>
                                    <select id="source-remote"></select>
                                </div>
                                <div class="form-group">
                                    <label>Path</label>
                                    <input type="text" id="source-path" value="/" placeholder="my-bucket/folder/files">
                                </div>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 1rem; font-size: 14px; color: var(--text-secondary);">Destination</h4>
                                <div class="form-group">
                                    <label>Remote</label>
                                    <select id="dest-remote"></select>
                                </div>
                                <div class="form-group">
                                    <label>Path</label>
                                    <input type="text" id="dest-path" value="/" placeholder="backup-bucket/daily">
                                </div>
                            </div>
                        </div>
                        <button class="btn" onclick="startTransfer()">Start Transfer</button>
                    </div>

                    <h3 style="margin: 2rem 0 1rem; font-size: 18px; font-weight: 600;">Active Transfers</h3>
                    <div id="transfers-list"></div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="tab-history" class="tab-content hidden">
                <div class="content-header">
                    <h2>Transfer History</h2>
                    <p>View past transfers and statistics</p>
                </div>
                <div class="content-body">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="stat-total">0</div>
                            <div class="stat-label">Total Transfers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-completed" style="color: var(--success);">0</div>
                            <div class="stat-label">Completed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-failed" style="color: var(--error);">0</div>
                            <div class="stat-label">Failed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-running" style="color: var(--accent-orange);">0</div>
                            <div class="stat-label">Running</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Filter</div>
                            <select id="history-filter" onchange="loadHistory()" style="width: 200px;">
                                <option value="">All Transfers</option>
                                <option value="completed">Completed</option>
                                <option value="failed">Failed</option>
                                <option value="running">Running</option>
                            </select>
                        </div>
                    </div>

                    <div id="history-list"></div>
                </div>
            </div>

            <!-- Scheduled Tab -->
            <div id="tab-scheduled" class="tab-content hidden">
                <div class="content-header">
                    <h2>Scheduled Jobs</h2>
                    <p>Manage recurring and one-time scheduled transfers</p>
                </div>
                <div class="content-body">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="stat-scheduled-total">0</div>
                            <div class="stat-label">Total Scheduled</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-scheduled-active" style="color: var(--success);">0</div>
                            <div class="stat-label">Active</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-scheduled-disabled" style="color: var(--text-tertiary);">0</div>
                            <div class="stat-label">Disabled</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-scheduled-recurring" style="color: var(--accent-orange);">0</div>
                            <div class="stat-label">Recurring</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Filter</div>
                            <select id="scheduled-filter" onchange="loadScheduled()" style="width: 200px;">
                                <option value="">All Jobs</option>
                                <option value="recurring">Recurring Only</option>
                                <option value="once">One-Time Only</option>
                                <option value="active">Active Only</option>
                                <option value="disabled">Disabled Only</option>
                            </select>
                        </div>
                    </div>

                    <div id="scheduled-list"></div>
                </div>
            </div>

            <!-- Logs Tab -->
            <div id="tab-logs" class="tab-content hidden">
                <div class="content-header">
                    <h2>Audit Logs</h2>
                </div>
                <div class="content-body">
                    <div class="card">
                        <div class="card-header">
                            <h3>Activity Logs</h3>
                            <div style="display: flex; gap: 1rem;">
                                <select id="logs-action-filter" onchange="loadLogs()" style="width: 180px;">
                                    <option value="">All Actions</option>
                                    <option value="login_success">Logins</option>
                                    <option value="transfer_created">Transfers Created</option>
                                    <option value="transfer_deleted">Transfers Deleted</option>
                                    <option value="remote_created">Remotes Created</option>
                                    <option value="remote_updated">Remotes Updated</option>
                                    <option value="remote_deleted">Remotes Deleted</option>
                                    <option value="smtp_configured">SMTP Configured</option>
                                    <option value="permission_denied">Permission Denied</option>
                                </select>
                                <select id="logs-resource-filter" onchange="loadLogs()" style="width: 150px;">
                                    <option value="">All Resources</option>
                                    <option value="transfer">Transfers</option>
                                    <option value="remote">Remotes</option>
                                    <option value="auth">Authentication</option>
                                    <option value="settings">Settings</option>
                                    <option value="user">Users</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="logs-list" style="max-height: 600px; overflow-y: auto;"></div>
                            <div style="margin-top: 1rem; display: flex; justify-content: center; gap: 1rem;">
                                <button id="logs-prev" class="btn btn-secondary btn-small" onclick="loadLogsPage(-1)" disabled>Previous</button>
                                <span id="logs-page-info" style="color: var(--text-secondary); line-height: 32px;">Page 1</span>
                                <button id="logs-next" class="btn btn-secondary btn-small" onclick="loadLogsPage(1)">Next</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Decrypt Tab -->
            <div id="tab-decrypt" class="tab-content hidden">
                <div class="content-header">
                    <h2>üîì Decrypt Files</h2>
                    <p>Decrypt files that were encrypted during transfer</p>
                </div>
                <div class="content-body">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Decrypt Encrypted Files</div>
                        </div>
                        
                        <div style="padding: 1rem; background: rgba(var(--info-rgb), 0.1); border-left: 3px solid var(--info); border-radius: 4px; margin-bottom: 1.5rem;">
                            <strong>‚ÑπÔ∏è How Decryption Works:</strong>
                            <p style="margin: 0.5rem 0 0 0; font-size: 13px; color: var(--text-secondary);">
                                When you encrypted files during a transfer, they were stored using AES-256 encryption. 
                                To access the original files, you need the encryption password you saved. 
                                This process will decrypt the files and save them to your chosen destination.
                            </p>
                        </div>
                        
                        <div class="form-group">
                            <label>Encrypted Source Remote</label>
                            <select id="decrypt-source-remote">
                                <option value="">Select remote with encrypted files...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Encrypted Path</label>
                            <input type="text" id="decrypt-source-path" placeholder="encrypted-folder or leave blank for root">
                            <small style="color: var(--text-tertiary); font-size: 12px;">
                                The FOLDER/DIRECTORY where your encrypted files are stored. Leave blank to decrypt all files in the remote, or enter the directory path (e.g., "backups/encrypted").
                                <strong>Note:</strong> Do NOT enter individual encrypted filenames (they look like random strings) - CloudKlone will automatically find and decrypt all files in the directory.
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label>Decryption Password *</label>
                            <input type="password" id="decrypt-password" placeholder="Enter the password used to encrypt these files" required>
                            <small style="color: var(--text-tertiary); font-size: 12px;">
                                This is the password shown when you created the encrypted transfer
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label>Destination Remote</label>
                            <select id="decrypt-dest-remote">
                                <option value="">Select destination for decrypted files...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Destination Path</label>
                            <input type="text" id="decrypt-dest-path" placeholder="decrypted-files">
                            <small style="color: var(--text-tertiary); font-size: 12px;">
                                Where to save the decrypted files
                            </small>
                        </div>
                        
                        <div style="padding: 0.75rem; background: rgba(var(--warning-rgb), 0.1); border-left: 3px solid var(--warning); border-radius: 4px; margin-bottom: 1.5rem; font-size: 13px;">
                            ‚ö†Ô∏è <strong>Important:</strong> Make sure you have the correct password. Incorrect passwords will fail silently or produce corrupted output.
                        </div>
                        
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn" onclick="startDecryption()">Start Decryption</button>
                            <button class="btn btn-secondary" onclick="testDecryptPassword()">Test Password</button>
                        </div>
                    </div>
                    
                    <!-- Decryption Progress -->
                    <div id="decrypt-progress-card" class="card" style="margin-top: 2rem; display: none;">
                        <div class="card-header">
                            <div class="card-title">Decryption Progress</div>
                        </div>
                        <div id="decrypt-progress-content"></div>
                    </div>
                    
                    <!-- Recent Decryptions -->
                    <div class="card" style="margin-top: 2rem;">
                        <div class="card-header">
                            <div class="card-title">Recent Decryptions</div>
                            <button class="btn btn-secondary btn-small" onclick="loadDecryptionHistory()">Refresh</button>
                        </div>
                        <div id="decrypt-history-list"></div>
                    </div>
                </div>
            </div>

            <!-- Remotes Tab -->
            <div id="tab-remotes" class="tab-content hidden">
                <div class="content-header">
                    <h2>Remotes</h2>
                    <p>Manage cloud storage connections</p>
                </div>
                <div class="content-body">
                    <div id="add-remote-section" class="card">
                        <div class="card-header">
                            <div class="card-title">Add Remote</div>
                        </div>
                        <div class="form-group">
                            <label>Remote Name</label>
                            <input type="text" id="remote-name" placeholder="my-remote">
                        </div>
                        <div class="form-group">
                            <label>Provider</label>
                            <select id="provider">
                                <option value="">Select provider...</option>
                            </select>
                        </div>
                        <div id="provider-config"></div>
                        <button class="btn" onclick="addRemote()">Add Remote</button>
                    </div>

                    <h3 style="margin: 2rem 0 1rem; font-size: 18px; font-weight: 600;">Your Remotes</h3>
                    <div id="remotes-list"></div>
                </div>
            </div>

            <!-- Tests & Queries Tab -->
            <div id="tab-tests" class="tab-content hidden">
                <div class="content-header">
                    <h2>Tests & Queries</h2>
                    <p>Test transfers safely and query remote information</p>
                </div>
                <div class="content-body">
                    <!-- Dry-Run Tester -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Dry-Run Tester</div>
                        </div>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 14px;">
                            Preview what will happen during a transfer WITHOUT actually moving any files. Perfect for testing before creating real transfers.
                        </p>
                        <div class="form-group">
                            <label>Operation</label>
                            <select id="test-operation">
                                <option value="copy">Copy</option>
                                <option value="sync">Sync</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Source Remote</label>
                            <select id="test-source-remote">
                                <option value="">Select remote...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Source Path</label>
                            <input type="text" id="test-source-path" placeholder="folder/subfolder or leave blank for root">
                        </div>
                        <div class="form-group">
                            <label>Destination Remote</label>
                            <select id="test-dest-remote">
                                <option value="">Select remote...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Destination Path</label>
                            <input type="text" id="test-dest-path" placeholder="folder/subfolder or leave blank for root">
                        </div>
                        <button class="btn" onclick="runDryRun()">Run Dry-Run Test</button>
                        <div id="dry-run-output" style="margin-top: 1rem; display: none;">
                            <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 0.5rem;">Dry-Run Results:</h4>
                            <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 1rem; font-family: 'Monaco', monospace; font-size: 12px; max-height: 400px; overflow-y: auto; white-space: pre-wrap;" id="dry-run-results"></div>
                        </div>
                    </div>

                    <!-- Query Builder -->
                    <div class="card" style="margin-top: 2rem;">
                        <div class="card-header">
                            <div class="card-title">Query Builder</div>
                        </div>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 14px;">
                            Run read-only rclone commands to inspect remotes. No files will be modified.
                        </p>
                        <div class="form-group">
                            <label>Remote</label>
                            <select id="query-remote">
                                <option value="">Select remote...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Path (optional)</label>
                            <input type="text" id="query-path" placeholder="folder/subfolder or leave blank for root">
                        </div>
                        <div class="form-group">
                            <label>Command</label>
                            <select id="query-command">
                                <option value="lsd">lsd - List directories</option>
                                <option value="ls">ls - List all files and directories</option>
                                <option value="lsl">lsl - List with details (size, modified)</option>
                                <option value="lsf">lsf - List files only</option>
                                <option value="size">size - Show total size</option>
                                <option value="about">about - Show quota and usage</option>
                                <option value="tree">tree - Show directory tree</option>
                                <option value="cat">cat - Display file contents</option>
                            </select>
                        </div>
                        <div id="query-file-input" class="form-group" style="display: none;">
                            <label>File Name (required for cat)</label>
                            <input type="text" id="query-filename" placeholder="example.txt">
                        </div>
                        <button class="btn btn-secondary" onclick="runQuery()">Run Query</button>
                        <div id="query-output" style="margin-top: 1rem; display: none;">
                            <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 0.5rem;">Query Results:</h4>
                            <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 1rem; font-family: 'Monaco', monospace; font-size: 12px; max-height: 400px; overflow-y: auto; white-space: pre-wrap;" id="query-results"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="tab-settings" class="tab-content hidden">
                <div class="content-header">
                    <h2>Settings</h2>
                    <p>Configure notifications and preferences</p>
                </div>
                <div class="content-body">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Email Notifications</div>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="email-enabled" style="width: auto;">
                                Enable email notifications
                            </label>
                        </div>
                        <div class="form-group">
                            <label>Notification Email</label>
                            <input type="email" id="email-address" placeholder="your-email@example.com">
                        </div>
                        <h4 style="margin: 2rem 0 1rem; font-size: 14px; font-weight: 600;">SMTP Server</h4>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>SMTP Host</label>
                                <input type="text" id="smtp-host" placeholder="smtp.gmail.com">
                            </div>
                            <div class="form-group">
                                <label>SMTP Port</label>
                                <input type="number" id="smtp-port" placeholder="587">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>From Email (Sender Address)</label>
                            <input type="email" id="from-email" placeholder="cloudklone@yourdomain.com">
                            <small style="display: block; margin-top: 0.5rem; color: var(--text-tertiary); font-size: 12px;">
                                Must be verified in your SMTP provider (e.g., Brevo, SendGrid)
                            </small>
                        </div>
                        <h4 style="margin: 2rem 0 1rem; font-size: 14px; font-weight: 600;">SMTP Authentication</h4>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Username (Login)</label>
                                <input type="text" id="smtp-user" placeholder="your-login@example.com">
                            </div>
                            <div class="form-group">
                                <label>Password</label>
                                <input type="password" id="smtp-pass" placeholder="your-password">
                            </div>
                        </div>
                        <h4 style="margin: 2rem 0 1rem; font-size: 14px; font-weight: 600;">Notification Preferences</h4>
                        <div class="form-group">
                            <label>Timezone for Daily Reports</label>
                            <select id="timezone" class="form-control">
                                <option value="America/New_York">Eastern Time (ET)</option>
                                <option value="America/Chicago">Central Time (CT)</option>
                                <option value="America/Denver">Mountain Time (MT)</option>
                                <option value="America/Los_Angeles">Pacific Time (PT)</option>
                                <option value="America/Phoenix">Arizona (MST - No DST)</option>
                                <option value="America/Anchorage">Alaska Time (AKT)</option>
                                <option value="Pacific/Honolulu">Hawaii Time (HST)</option>
                                <option value="Europe/London">London (GMT/BST)</option>
                                <option value="Europe/Paris">Paris (CET/CEST)</option>
                                <option value="Europe/Berlin">Berlin (CET/CEST)</option>
                                <option value="Asia/Tokyo">Tokyo (JST)</option>
                                <option value="Asia/Shanghai">Shanghai (CST)</option>
                                <option value="Asia/Dubai">Dubai (GST)</option>
                                <option value="Australia/Sydney">Sydney (AEDT/AEST)</option>
                                <option value="UTC">UTC (Universal Time)</option>
                            </select>
                            <small style="display: block; margin-top: 0.5rem; color: var(--text-tertiary); font-size: 12px;">
                                Daily reports will be sent at midnight in your selected timezone
                            </small>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="notify-failure" style="width: auto;" checked>
                                Notify on transfer failure
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="notify-success" style="width: auto;">
                                Notify on transfer success
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="daily-report" style="width: auto;">
                                Daily summary report (sent at midnight)
                            </label>
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn" onclick="saveSettings()">Save Settings</button>
                            <button class="btn btn-secondary" onclick="testEmail()">Test Email</button>
                        </div>
                    </div>
                    
                    <!-- Webhook Notifications -->
                    <div class="card" style="margin-top: 2rem;">
                        <div class="card-header">
                            <div class="card-title">Webhook Notifications</div>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="webhook-enabled" style="width: auto;">
                                Enable webhook notifications
                            </label>
                        </div>
                        <div class="form-group">
                            <label>Webhook Type</label>
                            <select id="webhook-type" class="form-control">
                                <option value="slack">Slack</option>
                                <option value="teams">Microsoft Teams</option>
                                <option value="discord">Discord</option>
                                <option value="generic">Generic (JSON)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Webhook URL</label>
                            <input type="url" id="webhook-url" placeholder="https://hooks.slack.com/services/...">
                            <small style="display: block; margin-top: 0.5rem; color: var(--text-tertiary); font-size: 12px;">
                                <strong>Slack:</strong> Create an Incoming Webhook in your workspace<br>
                                <strong>Teams:</strong> Add an Incoming Webhook connector to your channel<br>
                                <strong>Discord:</strong> Create a Webhook in your channel settings
                            </small>
                        </div>
                        
                        <h4 style="margin: 2rem 0 1rem; font-size: 14px; font-weight: 600;">Webhook Notification Preferences</h4>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="webhook-notify-failure" style="width: auto;" checked>
                                Notify on transfer failure
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="webhook-notify-success" style="width: auto;">
                                Notify on transfer success
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="webhook-daily-report" style="width: auto;">
                                Daily summary report (sent at midnight)
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn btn-secondary" onclick="testWebhook()">Test Webhook</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Tab -->
            <div id="tab-admin" class="tab-content hidden">
                <div class="content-header">
                    <h2>Admin Panel</h2>
                    <p>Manage users, groups, and system settings</p>
                </div>
                <div class="content-body">
                    <!-- User Management -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Users</div>
                            <button id="create-user-btn" class="btn btn-small hidden" onclick="showCreateUser()">Create User</button>
                        </div>
                        
                        <!-- Create User Form (Hidden by default) -->
                        <div id="create-user-form" class="hidden" style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                            <h4 style="margin-bottom: 1rem; font-size: 14px; font-weight: 600;">New User</h4>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Username</label>
                                    <input type="text" id="new-username" placeholder="username">
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" id="new-email" placeholder="user@example.com">
                                </div>
                            </div>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Password</label>
                                    <input type="password" id="new-password" placeholder="password">
                                </div>
                                <div class="form-group">
                                    <label>Group</label>
                                    <select id="new-user-group">
                                        <option value="">No group</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="new-is-admin" style="width: auto;">
                                    Admin privileges
                                </label>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-small" onclick="createUser()">Create</button>
                                <button class="btn btn-secondary btn-small" onclick="hideCreateUser()">Cancel</button>
                            </div>
                        </div>
                        
                        <!-- Edit User Form (Hidden by default) -->
                        <div id="edit-user-form" class="hidden" style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                            <h4 style="margin-bottom: 1rem; font-size: 14px; font-weight: 600;">Edit User</h4>
                            <input type="hidden" id="edit-user-id">
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Username</label>
                                    <input type="text" id="edit-username" disabled style="opacity: 0.6; cursor: not-allowed;">
                                    <small style="display: block; margin-top: 0.5rem; color: var(--text-tertiary); font-size: 12px;">
                                        Username cannot be changed
                                    </small>
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" id="edit-email" placeholder="user@example.com">
                                </div>
                            </div>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Group</label>
                                    <select id="edit-user-group">
                                        <option value="">No group</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Role</label>
                                    <select id="edit-user-role">
                                        <option value="user">User</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>New Password (leave blank to keep current)</label>
                                <input type="password" id="edit-password" placeholder="new password">
                                <small style="display: block; margin-top: 0.5rem; color: var(--text-tertiary); font-size: 12px;">
                                    Only fill this if you want to change the user's password
                                </small>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-small" onclick="updateUser()">Save Changes</button>
                                <button class="btn btn-secondary btn-small" onclick="hideEditUser()">Cancel</button>
                            </div>
                        </div>
                        
                        <div id="users-list"></div>
                    </div>

                    <!-- Group Management -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Groups</div>
                            <button id="create-group-btn" class="btn btn-small hidden" onclick="showCreateGroup()">Create Group</button>
                        </div>
                        
                        <!-- Create Group Form -->
                        <div id="create-group-form" class="hidden" style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                            <h4 style="margin-bottom: 1rem; font-size: 14px; font-weight: 600;">New Group</h4>
                            <div class="form-group">
                                <label>Group Name</label>
                                <input type="text" id="new-group-name" placeholder="Engineering">
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <input type="text" id="new-group-desc" placeholder="Engineering team members">
                            </div>
                            <div class="form-group">
                                <label>Role / Permissions</label>
                                <select id="new-group-role" onchange="updateRoleDescription()">
                                    <option value="read_only">Read-Only (View only)</option>
                                    <option value="operator" selected>Operator (Create copy transfers only)</option>
                                    <option value="power_user">Power User (Create sync, manage remotes)</option>
                                </select>
                                <small id="role-description" style="color: var(--text-tertiary); font-size: 11px; display: block; margin-top: 0.5rem;">
                                    Can view everything and create copy transfers. Cannot create sync transfers or delete transfers.
                                </small>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-small" onclick="createGroup()">Create</button>
                                <button class="btn btn-secondary btn-small" onclick="hideCreateGroup()">Cancel</button>
                            </div>
                        </div>
                        
                        <div id="groups-list"></div>
                    </div>

                    <!-- SSH Host Keys Management -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">SSH Host Keys</div>
                            <button class="btn btn-small btn-secondary" onclick="refreshHostKeys()">Refresh</button>
                        </div>
                        <p style="font-size: 13px; color: var(--text-tertiary); margin-bottom: 1rem;">
                            Manage SSH host keys for SFTP remotes. Host keys are automatically scanned when creating SFTP remotes for security.
                        </p>
                        <div id="ssh-host-keys-list"></div>
                    </div>

                    <!-- System Tools -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">System Tools</div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                                <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 0.5rem;">Cancel Stuck Transfers</h4>
                                <p style="font-size: 13px; color: var(--text-tertiary); margin-bottom: 1rem;">
                                    Find and cancel all transfers stuck in "running" state for 10+ minutes with no progress.
                                </p>
                                <button class="btn btn-danger btn-small" onclick="cancelAllStuck()">Cancel All Stuck Transfers</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Admin Shell -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Admin Shell</div>
                        </div>
                        <p style="font-size: 13px; color: var(--text-tertiary); margin-bottom: 1rem;">
                            ‚ö†Ô∏è <strong>Warning:</strong> Direct access to rclone commands. Use with caution. All commands are logged.
                        </p>
                        
                        <div style="background: #1a1a1a; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; font-family: 'Monaco', 'Courier New', monospace; font-size: 13px;">
                            <div style="color: #4CAF50; margin-bottom: 0.5rem;">
                                <strong>Available Commands:</strong>
                            </div>
                            <div style="color: #ccc; line-height: 1.8;">
                                ‚Ä¢ <code>rclone lsd remote:</code> - List directories<br>
                                ‚Ä¢ <code>rclone ls remote:path</code> - List files<br>
                                ‚Ä¢ <code>rclone size remote:path</code> - Calculate size<br>
                                ‚Ä¢ <code>rclone copy source: dest:</code> - Copy files<br>
                                ‚Ä¢ <code>rclone sync source: dest:</code> - Sync directories<br>
                                ‚Ä¢ <code>rclone config dump</code> - Show config<br>
                                ‚Ä¢ <code>rclone version</code> - Show version<br>
                                ‚Ä¢ Full rclone documentation: <a href="https://rclone.org/commands/" target="_blank" style="color: #2196F3;">rclone.org/commands</a>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Command</label>
                            <input type="text" id="shell-command" placeholder="rclone version" onkeypress="if(event.key==='Enter') runShellCommand()" autofocus>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                            <button class="btn" onclick="runShellCommand()">Execute</button>
                            <button class="btn btn-secondary" onclick="clearShellOutput()">Clear Output</button>
                        </div>
                        
                        <div id="shell-output" style="background: #000; border-radius: 8px; padding: 1rem; font-family: 'Monaco', 'Courier New', monospace; font-size: 12px; color: #0f0; min-height: 300px; max-height: 500px; overflow-y: auto; white-space: pre-wrap; display: none;"></div>
                        
                        <div id="shell-history" style="margin-top: 1rem; display: none;">
                            <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-secondary);">Command History</h4>
                            <div id="shell-history-list" style="font-family: 'Monaco', monospace; font-size: 12px; color: var(--text-tertiary);"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Force Password Change Modal -->
    <div id="force-password-change-modal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.9); display: flex; align-items: center; justify-content: center; z-index: 9999;">
        <div style="background: var(--bg-secondary); border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; border: 2px solid var(--accent);">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="font-size: 48px; margin-bottom: 0.5rem;"></div>
                <h3 style="margin: 0; color: var(--accent);">Change Default Password</h3>
                <p style="margin-top: 0.5rem; color: var(--text-secondary); font-size: 14px;">
                    For security, you must change the default password before continuing
                </p>
            </div>
            
            <div class="form-group">
                <label>Current Password</label>
                <input type="password" id="force-current-password" placeholder="admin" autofocus>
            </div>
            
            <div class="form-group">
                <label>New Password (minimum 6 characters)</label>
                <input type="password" id="force-new-password" placeholder="Enter new password">
            </div>
            
            <div class="form-group">
                <label>Confirm New Password</label>
                <input type="password" id="force-confirm-password" placeholder="Confirm new password" onkeypress="if(event.key==='Enter') forceChangePassword()">
            </div>
            
            <div id="force-password-error" style="color: var(--danger); font-size: 13px; margin-bottom: 1rem; text-align: center;"></div>
            
            <button class="btn" onclick="forceChangePassword()" style="width: 100%;">Change Password</button>
        </div>
    </div>

    <!-- Edit Scheduled Job Modal -->
    <div id="edit-schedule-modal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1000;">
        <div style="background: var(--bg-secondary); border-radius: 12px; padding: 2rem; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="margin: 0;">Edit Scheduled Transfer</h3>
                <button onclick="closeEditScheduleModal()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 24px; padding: 0; width: 32px; height: 32px;">&times;</button>
            </div>
            
            <input type="hidden" id="edit-schedule-id">
            
            <div class="form-group">
                <label>Schedule Type</label>
                <select id="edit-schedule-type" onchange="toggleEditScheduleType()">
                    <option value="once">One-time</option>
                    <option value="recurring">Recurring</option>
                </select>
            </div>
            
            <div id="edit-schedule-once" class="form-group hidden">
                <label>Date and Time</label>
                <input type="datetime-local" id="edit-schedule-datetime">
            </div>
            
            <div id="edit-schedule-recurring" class="form-group hidden">
                <label>Frequency</label>
                <select id="edit-schedule-interval">
                    <option value="hourly">Hourly</option>
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                </select>
            </div>
            
            <div id="edit-schedule-time-group" class="form-group hidden">
                <label>Time</label>
                <input type="time" id="edit-schedule-time" value="00:00">
            </div>
            
            <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                <button class="btn" onclick="saveScheduledJobEdit()" style="flex: 1;">Save Changes</button>
                <button class="btn btn-secondary" onclick="closeEditScheduleModal()" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let token = localStorage.getItem('token');
        let ws = null;
        let currentTab = 'transfers';
        let userPermissions = null; // Store user permissions
        let isAdmin = false; // Store admin status

        if (token) showApp();

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    token = data.token;
                    localStorage.setItem('token', token);
                    
                    // Check if password needs to be changed
                    if (data.user.passwordChanged === false) {
                        // Store current password for verification
                        document.getElementById('force-current-password').value = password;
                        document.getElementById('force-password-change-modal').classList.remove('hidden');
                    } else {
                        showApp();
                    }
                } else {
                    document.getElementById('login-error').textContent = data.error;
                }
            } catch (err) {
                document.getElementById('login-error').textContent = 'Connection failed';
            }
        }

        async function forceChangePassword() {
            const currentPassword = document.getElementById('force-current-password').value;
            const newPassword = document.getElementById('force-new-password').value;
            const confirmPassword = document.getElementById('force-confirm-password').value;
            const errorDiv = document.getElementById('force-password-error');
            
            errorDiv.textContent = '';
            
            // Validation
            if (!currentPassword || !newPassword || !confirmPassword) {
                errorDiv.textContent = 'All fields are required';
                return;
            }
            
            if (newPassword.length < 6) {
                errorDiv.textContent = 'New password must be at least 6 characters';
                return;
            }
            
            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'Passwords do not match';
                return;
            }
            
            if (newPassword === currentPassword) {
                errorDiv.textContent = 'New password must be different from current password';
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/auth/change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ currentPassword, newPassword })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    // Password changed successfully
                    document.getElementById('force-password-change-modal').classList.add('hidden');
                    document.getElementById('force-current-password').value = '';
                    document.getElementById('force-new-password').value = '';
                    document.getElementById('force-confirm-password').value = '';
                    showApp();
                } else {
                    errorDiv.textContent = data.error || 'Failed to change password';
                }
            } catch (err) {
                errorDiv.textContent = 'Connection failed';
            }
        }

        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update button text
            const btn = document.getElementById('theme-toggle-btn');
            if (newTheme === 'light') {
                btn.textContent = '‚òÄÔ∏è Light Mode';
            } else {
                btn.textContent = 'üåô Dark Mode';
            }
        }
        
        function logout() {
            token = null;
            localStorage.removeItem('token');
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('app-section').classList.add('hidden');
            if (ws) ws.close();
        }

        function showApp() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('app-section').classList.remove('hidden');
            
            // Decode JWT to check if admin
            const tokenParts = token.split('.');
            if (tokenParts.length === 3) {
                const payload = JSON.parse(atob(tokenParts[1]));
                isAdmin = payload.isAdmin || false;
                if (isAdmin) {
                    document.getElementById('admin-nav').classList.remove('hidden');
                    // Show admin-only buttons
                    const createUserBtn = document.getElementById('create-user-btn');
                    const createGroupBtn = document.getElementById('create-group-btn');
                    if (createUserBtn) createUserBtn.classList.remove('hidden');
                    if (createGroupBtn) createGroupBtn.classList.remove('hidden');
                }
            }
            
            // Load user permissions and apply UI restrictions
            loadPermissions();
            
            loadProviders();
            loadRemotes();
            loadTransfers();
            loadHistory();
            loadSettings();
            loadLogs();
            connectWebSocket();
            setInterval(loadTransfers, 5000);
        }

        async function loadPermissions() {
            try {
                const res = await fetch(`${API_BASE}/auth/permissions`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                userPermissions = data.permissions;
                
                console.log('User permissions:', userPermissions);
                
                // Apply UI restrictions based on permissions
                applyPermissionRestrictions();
            } catch (err) {
                console.error('Failed to load permissions:', err);
                // Default to operator permissions for safety
                userPermissions = {
                    role: 'operator',
                    can_create_copy: true,
                    can_create_sync: false,
                    can_delete_own_transfers: false,
                    can_manage_remotes: false,
                    can_manage_settings: false
                };
                applyPermissionRestrictions();
            }
        }

        function applyPermissionRestrictions() {
            if (!userPermissions) return;
            
            // Hide Remotes tab if can't manage remotes
            if (!userPermissions.can_manage_remotes) {
                const remotesNav = document.getElementById('remotes-nav');
                if (remotesNav) remotesNav.classList.add('hidden');
                
                // Hide the "Add Remote" section too
                const addRemoteSection = document.getElementById('add-remote-section');
                if (addRemoteSection) addRemoteSection.style.display = 'none';
            }
            
            // Hide Settings tab if can't manage settings
            if (!userPermissions.can_manage_settings) {
                const settingsNav = document.getElementById('settings-nav');
                if (settingsNav) settingsNav.classList.add('hidden');
            }
            
            // Hide sync operation option if can't create sync
            if (!userPermissions.can_create_sync) {
                const syncOption = document.querySelector('option[value="sync"]');
                if (syncOption) syncOption.style.display = 'none';
            }
        }

        function showTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            event.target.classList.add('active');
            
            if (tab === 'history') loadHistory();
            if (tab === 'scheduled') loadScheduled();
            if (tab === 'logs') loadLogs();
            if (tab === 'admin') {
                loadUsers();
                loadGroups();
                refreshHostKeys();
            }
        }
        
        function toggleSchedule() {
            const enabled = document.getElementById('schedule-enabled').checked;
            document.getElementById('schedule-options').classList.toggle('hidden', !enabled);
        }
        
        function toggleScheduleType() {
            const type = document.getElementById('schedule-type').value;
            document.getElementById('schedule-once').classList.toggle('hidden', type !== 'once');
            document.getElementById('schedule-recurring').classList.toggle('hidden', type !== 'recurring');
        }
        
        function toggleEncryption() {
            const enabled = document.getElementById('encrypt-enabled').checked;
            document.getElementById('encryption-options').classList.toggle('hidden', !enabled);
        }

        // ==================== ADMIN FUNCTIONS ====================
        
        async function loadUsers() {
            try {
                const res = await fetch(`${API_BASE}/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                // Get groups for display
                const groupsRes = await fetch(`${API_BASE}/groups`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const groupsData = await groupsRes.json();
                const groupsMap = {};
                groupsData.groups.forEach(g => groupsMap[g.id] = g.name);
                
                const list = document.getElementById('users-list');
                if (data.users.length === 0) {
                    list.innerHTML = '<div class="empty-state"><p>No users found</p></div>';
                    return;
                }
                
                list.innerHTML = data.users.map(u => {
                    const groupName = u.group_id ? groupsMap[u.group_id] : 'No group';
                    return `
                    <div class="remote-item">
                        <div class="remote-info">
                            <h4>${u.username} ${u.is_admin ? '<span style="color: var(--accent-orange); font-size: 11px; font-weight: 600;">[ADMIN]</span>' : ''}</h4>
                            <p>${u.email} ‚Ä¢ Group: ${groupName} ‚Ä¢ Created ${new Date(u.created_at).toLocaleDateString()}</p>
                        </div>
                        ${isAdmin ? `
                        <div class="remote-actions">
                            <button class="btn btn-secondary btn-small" onclick='showEditUser(${JSON.stringify(u)})'>Edit</button>
                            <button class="btn btn-danger btn-small" onclick="deleteUser(${u.id}, '${u.username}')">Delete</button>
                        </div>
                        ` : ''}
                    </div>
                `}).join('');
            } catch (err) {
                console.error('Failed to load users:', err);
            }
        }

        async function loadGroups() {
            try {
                const res = await fetch(`${API_BASE}/groups`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                // Update group dropdown in create user form
                const groupSelect = document.getElementById('new-user-group');
                groupSelect.innerHTML = '<option value="">No group</option>';
                data.groups.forEach(g => {
                    groupSelect.innerHTML += `<option value="${g.id}">${g.name}</option>`;
                });
                
                const list = document.getElementById('groups-list');
                if (data.groups.length === 0) {
                    list.innerHTML = '<div class="empty-state"><p>No groups created yet</p></div>';
                    return;
                }
                
                list.innerHTML = data.groups.map(g => {
                    const role = g.permissions?.role || 'operator';
                    const roleLabels = {
                        'read_only': 'üëÅÔ∏è Read-Only',
                        'operator': '‚öôÔ∏è Operator',
                        'power_user': '‚ö° Power User'
                    };
                    const roleLabel = roleLabels[role] || role;
                    
                    return `
                    <div class="remote-item">
                        <div class="remote-info">
                            <h4>${g.name}</h4>
                            <p>${g.description || 'No description'}</p>
                            <div style="margin-top: 0.5rem;">
                                <span style="display: inline-block; padding: 0.25rem 0.75rem; background: var(--bg-tertiary); border-radius: 12px; font-size: 11px; color: var(--text-secondary);">${roleLabel}</span>
                            </div>
                        </div>
                        ${isAdmin ? `
                        <div class="remote-actions">
                            <button class="btn btn-danger btn-small" onclick="deleteGroup(${g.id}, '${g.name}')">Delete</button>
                        </div>
                        ` : ''}
                    </div>
                `}).join('');
            } catch (err) {
                console.error('Failed to load groups:', err);
            }
        }

        function showCreateUser() {
            document.getElementById('create-user-form').classList.remove('hidden');
        }

        function hideCreateUser() {
            document.getElementById('create-user-form').classList.add('hidden');
            document.getElementById('new-username').value = '';
            document.getElementById('new-email').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('new-user-group').value = '';
            document.getElementById('new-is-admin').checked = false;
        }

        async function createUser() {
            const username = document.getElementById('new-username').value;
            const email = document.getElementById('new-email').value;
            const password = document.getElementById('new-password').value;
            const isAdmin = document.getElementById('new-is-admin').checked;
            
            if (!username || !email || !password) {
                alert('Please fill in all required fields');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ username, email, password, isAdmin })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    hideCreateUser();
                    loadUsers();
                    alert('SUCCESS: User created successfully!');
                } else {
                    alert('ERROR: ' + (data.error || 'Failed to create user'));
                }
            } catch (err) {
                alert('ERROR: Failed to create user: ' + err.message);
            }
        }

        async function deleteUser(id, username) {
            if (!confirm(`Delete user "${username}"? This cannot be undone.`)) return;
            
            try {
                await fetch(`${API_BASE}/users/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadUsers();
                alert('SUCCESS: User deleted');
            } catch (err) {
                alert('ERROR: Failed to delete user');
            }
        }

        async function showEditUser(user) {
            // Hide create form if open
            document.getElementById('create-user-form').classList.add('hidden');
            
            // Load groups into dropdown
            const groupsRes = await fetch(`${API_BASE}/groups`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const groupsData = await groupsRes.json();
            
            const groupSelect = document.getElementById('edit-user-group');
            groupSelect.innerHTML = '<option value="">No group</option>';
            groupsData.groups.forEach(g => {
                const selected = g.id === user.group_id ? 'selected' : '';
                groupSelect.innerHTML += `<option value="${g.id}" ${selected}>${g.name}</option>`;
            });
            
            // Populate form
            document.getElementById('edit-user-id').value = user.id;
            document.getElementById('edit-username').value = user.username;
            document.getElementById('edit-email').value = user.email;
            document.getElementById('edit-user-group').value = user.group_id || '';
            document.getElementById('edit-user-role').value = user.is_admin ? 'admin' : 'user';
            document.getElementById('edit-password').value = '';
            
            // Show form
            document.getElementById('edit-user-form').classList.remove('hidden');
        }

        function hideEditUser() {
            document.getElementById('edit-user-form').classList.add('hidden');
        }

        async function updateUser() {
            const userId = document.getElementById('edit-user-id').value;
            const email = document.getElementById('edit-email').value;
            const groupIdValue = document.getElementById('edit-user-group').value;
            const groupId = groupIdValue === '' ? null : parseInt(groupIdValue);
            const role = document.getElementById('edit-user-role').value;
            const password = document.getElementById('edit-password').value;
            
            console.log('Raw values:', { userId, email, groupIdValue, role, password });
            console.log('Parsed groupId:', groupId, typeof groupId);
            
            if (!email) {
                alert('Email is required');
                return;
            }
            
            try {
                const updates = {
                    email,
                    groupId,
                    isAdmin: role === 'admin'
                };
                
                // Only include password if provided
                if (password) {
                    updates.password = password;
                }
                
                console.log('Sending update:', JSON.stringify(updates, null, 2));
                
                const res = await fetch(`${API_BASE}/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(updates)
                });
                
                const data = await res.json();
                console.log('Server response:', data);
                
                if (res.ok) {
                    hideEditUser();
                    loadUsers();
                    alert('SUCCESS: User updated successfully!');
                } else {
                    console.error('Update user error:', data);
                    alert('ERROR: ' + (data.error || 'Failed to update user'));
                }
            } catch (err) {
                console.error('Update user exception:', err);
                alert('ERROR: Failed to update user: ' + err.message);
            }
        }

        function showCreateGroup() {
            document.getElementById('create-group-form').classList.remove('hidden');
        }

        function hideCreateGroup() {
            document.getElementById('create-group-form').classList.add('hidden');
            document.getElementById('new-group-name').value = '';
            document.getElementById('new-group-desc').value = '';
        }

        function updateRoleDescription() {
            const role = document.getElementById('new-group-role')?.value;
            const desc = document.getElementById('role-description');
            if (!desc) return;
            
            const descriptions = {
                'read_only': 'Can only view transfers, remotes, history, and logs. Cannot create, edit, or delete anything.',
                'operator': 'Can view everything and create copy transfers. Cannot create sync transfers or delete transfers.',
                'power_user': 'Can create copy AND sync transfers, manage remotes, and delete own transfers. Cannot delete others\' transfers.'
            };
            
            desc.textContent = descriptions[role] || '';
        }

        function getRolePermissions(role) {
            const rolePermissions = {
                'read_only': {
                    role: 'read_only',
                    can_create_copy: false,
                    can_create_sync: false,
                    can_edit_transfers: false,
                    can_delete_own_transfers: false,
                    can_delete_any_transfers: false,
                    can_manage_remotes: false,
                    can_manage_settings: false,
                    can_manage_users: false
                },
                'operator': {
                    role: 'operator',
                    can_create_copy: true,
                    can_create_sync: false,
                    can_edit_transfers: false,
                    can_delete_own_transfers: false,
                    can_delete_any_transfers: false,
                    can_manage_remotes: false,
                    can_manage_settings: false,
                    can_manage_users: false
                },
                'power_user': {
                    role: 'power_user',
                    can_create_copy: true,
                    can_create_sync: true,
                    can_edit_transfers: false,
                    can_delete_own_transfers: true,
                    can_delete_any_transfers: false,
                    can_manage_remotes: true,
                    can_manage_settings: false,
                    can_manage_users: false
                }
            };
            
            return rolePermissions[role] || rolePermissions.operator;
        }

        async function createGroup() {
            const name = document.getElementById('new-group-name').value;
            const description = document.getElementById('new-group-desc').value;
            const role = document.getElementById('new-group-role').value;
            
            if (!name) {
                alert('Please enter a group name');
                return;
            }
            
            const permissions = getRolePermissions(role);
            
            try {
                const res = await fetch(`${API_BASE}/groups`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ name, description, permissions })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    hideCreateGroup();
                    loadGroups();
                    alert(`SUCCESS: Group "${name}" created with ${role.replace('_', ' ')} permissions!`);
                } else {
                    alert('ERROR: ' + (data.error || 'Failed to create group'));
                }
            } catch (err) {
                alert('ERROR: Failed to create group: ' + err.message);
            }
        }

        async function deleteGroup(id, name) {
            if (!confirm(`Delete group "${name}"? Users in this group will be unassigned.`)) return;
            
            try {
                await fetch(`${API_BASE}/groups/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadGroups();
                loadUsers(); // Refresh users to show group changes
                alert('SUCCESS: Group deleted');
            } catch (err) {
                alert('ERROR: Failed to delete group');
            }
        }

        async function cancelAllStuck() {
            if (!confirm('Cancel all transfers stuck in "running" state for 10+ minutes?\n\nThis will kill their processes immediately.')) return;
            
            try {
                const res = await fetch(`${API_BASE}/transfers/cancel-all-stuck`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (res.ok) {
                    alert(`SUCCESS: Cancelled ${data.count} stuck transfer(s)`);
                    loadTransfers();
                    loadHistory();
                } else {
                    alert('ERROR: Failed to cancel stuck transfers');
                }
            } catch (err) {
                alert('ERROR: Failed to cancel stuck transfers');
            }
        }

        async function refreshHostKeys() {
            if (!isAdmin) return;
            
            try {
                const res = await fetch(`${API_BASE}/admin/ssh-host-keys`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                const container = document.getElementById('ssh-host-keys-list');
                if (!data.hostKeys || data.hostKeys.length === 0) {
                    container.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-tertiary);">No SFTP remotes with host keys found</div>';
                    return;
                }
                
                container.innerHTML = data.hostKeys.map(hk => `
                    <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <strong>${hk.name}</strong>
                                    <span style="padding: 0.25rem 0.5rem; background: rgba(168, 85, 247, 0.2); color: rgb(168, 85, 247); border-radius: 4px; font-size: 11px;">SFTP</span>
                                </div>
                                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 0.5rem;">
                                     ${hk.host}:${hk.port || 22} ¬∑  ${hk.username || 'unknown'} ¬∑ Owner: ${hk.owner}
                                </div>
                                <div style="font-size: 12px; color: var(--text-tertiary); font-family: 'Monaco', monospace; max-width: 600px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    ${hk.ssh_host_key ? hk.ssh_host_key.split('\n')[0] : 'No host key'}...
                                </div>
                                <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 0.5rem;">
                                    Added: ${new Date(hk.created_at).toLocaleString()}
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-small btn-secondary" onclick="rescanHostKey(${hk.id}, '${hk.name}')">Rescan</button>
                                <button class="btn btn-small btn-danger" onclick="clearHostKey(${hk.id}, '${hk.name}')">Clear</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load SSH host keys:', err);
            }
        }

        async function rescanHostKey(id, name) {
            if (!confirm(`Rescan SSH host key for "${name}"?\n\nThis will connect to the server and update the stored host key.`)) return;
            
            try {
                const res = await fetch(`${API_BASE}/admin/ssh-host-keys/${id}/rescan`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (res.ok) {
                    alert(`SUCCESS: Host key rescanned successfully for "${name}"`);
                    refreshHostKeys();
                } else {
                    alert(`ERROR: ${data.error || 'Failed to rescan host key'}`);
                }
            } catch (err) {
                alert('ERROR: Failed to rescan host key');
            }
        }

        async function clearHostKey(id, name) {
            if (!confirm(`Clear SSH host key for "${name}"?\n\nWARNING: WARNING: After clearing the host key, this remote will not be able to connect until the host key is rescanned.`)) return;
            
            try {
                const res = await fetch(`${API_BASE}/admin/ssh-host-keys/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (res.ok) {
                    alert(`SUCCESS: Host key cleared for "${name}"`);
                    refreshHostKeys();
                } else {
                    alert('ERROR: Failed to clear host key');
                }
            } catch (err) {
                alert('ERROR: Failed to clear host key');
            }
        }

        async function toggleScheduledJob(id, enabled) {
            try {
                const res = await fetch(`${API_BASE}/transfers/${id}/toggle`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ enabled })
                });
                
                if (res.ok) {
                    loadScheduled();
                    alert(`SUCCESS: Job ${enabled ? 'enabled' : 'disabled'}`);
                } else {
                    alert('ERROR: Failed to toggle job');
                }
            } catch (err) {
                alert('ERROR: Failed to toggle job');
            }
        }

        async function editScheduledJob(id) {
            alert('Edit functionality coming soon!\n\nFor now, you can:\n1. Delete this job\n2. Create a new one with updated settings');
            // TODO: Add edit modal with schedule options
        }

        async function deleteScheduledJob(id) {
            if (!confirm('Delete this scheduled job?\n\nThis cannot be undone.')) return;
            
            try {
                const res = await fetch(`${API_BASE}/transfers/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (res.ok) {
                    loadScheduled();
                    alert('SUCCESS: Scheduled job deleted');
                } else {
                    alert('ERROR: Failed to delete job');
                }
            } catch (err) {
                alert('ERROR: Failed to delete job');
            }
        }

        function editScheduledJob(transfer) {
            // Store transfer ID
            document.getElementById('edit-schedule-id').value = transfer.id;
            
            // Set schedule type
            document.getElementById('edit-schedule-type').value = transfer.schedule_type;
            
            // Show appropriate fields
            if (transfer.schedule_type === 'once') {
                // Format scheduled_for for datetime-local input
                if (transfer.scheduled_for) {
                    const date = new Date(transfer.scheduled_for);
                    const formatted = date.toISOString().slice(0, 16);
                    document.getElementById('edit-schedule-datetime').value = formatted;
                }
                document.getElementById('edit-schedule-once').classList.remove('hidden');
                document.getElementById('edit-schedule-recurring').classList.add('hidden');
                document.getElementById('edit-schedule-time-group').classList.add('hidden');
            } else {
                // Recurring
                document.getElementById('edit-schedule-interval').value = transfer.schedule_interval || 'daily';
                
                // Use stored schedule_time if available, otherwise default to 00:00
                const time = transfer.schedule_time || '00:00';
                document.getElementById('edit-schedule-time').value = time;
                
                document.getElementById('edit-schedule-once').classList.add('hidden');
                document.getElementById('edit-schedule-recurring').classList.remove('hidden');
                document.getElementById('edit-schedule-time-group').classList.remove('hidden');
            }
            
            // Show modal
            document.getElementById('edit-schedule-modal').classList.remove('hidden');
        }

        function toggleEditScheduleType() {
            const type = document.getElementById('edit-schedule-type').value;
            if (type === 'once') {
                document.getElementById('edit-schedule-once').classList.remove('hidden');
                document.getElementById('edit-schedule-recurring').classList.add('hidden');
                document.getElementById('edit-schedule-time-group').classList.add('hidden');
            } else {
                document.getElementById('edit-schedule-once').classList.add('hidden');
                document.getElementById('edit-schedule-recurring').classList.remove('hidden');
                document.getElementById('edit-schedule-time-group').classList.remove('hidden');
            }
        }

        function closeEditScheduleModal() {
            document.getElementById('edit-schedule-modal').classList.add('hidden');
        }

        async function saveScheduledJobEdit() {
            const id = document.getElementById('edit-schedule-id').value;
            const type = document.getElementById('edit-schedule-type').value;
            
            const schedule = {
                enabled: true,
                type: type
            };
            
            if (type === 'once') {
                const datetime = document.getElementById('edit-schedule-datetime').value;
                if (!datetime) {
                    alert('Please select a date and time');
                    return;
                }
                schedule.datetime = datetime;
            } else {
                schedule.interval = document.getElementById('edit-schedule-interval').value;
                schedule.time = document.getElementById('edit-schedule-time').value;
                schedule.timezoneOffset = new Date().getTimezoneOffset();
            }
            
            try {
                const res = await fetch(`${API_BASE}/transfers/${id}/schedule`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ schedule })
                });
                
                if (res.ok) {
                    closeEditScheduleModal();
                    loadScheduled();
                    alert('SUCCESS: Schedule updated successfully');
                } else {
                    const data = await res.json();
                    alert('ERROR: ' + (data.error || 'Failed to update schedule'));
                }
            } catch (err) {
                alert('ERROR: Failed to update schedule');
            }
        }

        // ==================== LOGS FUNCTIONS ====================
        
        let logsPage = 0;
        const logsPageSize = 50;

        async function loadLogs() {
            try {
                const actionFilter = document.getElementById('logs-action-filter')?.value || '';
                const resourceFilter = document.getElementById('logs-resource-filter')?.value || '';
                
                const params = new URLSearchParams({
                    limit: logsPageSize,
                    offset: logsPage * logsPageSize
                });
                
                if (actionFilter) params.append('action', actionFilter);
                if (resourceFilter) params.append('resource_type', resourceFilter);
                
                const res = await fetch(`${API_BASE}/audit-logs?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                const list = document.getElementById('logs-list');
                if (!data.logs || data.logs.length === 0) {
                    list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><p>No audit logs</p><small style="color: var(--text-tertiary);">Activity will appear here</small></div>';
                    return;
                }
                
                list.innerHTML = data.logs.map(log => {
                    const timestamp = new Date(log.timestamp).toLocaleString();
                    const actionColor = getActionColor(log.action);
                    const actionLabel = formatActionLabel(log.action);
                    
                    return `
                    <div class="card" style="margin-bottom: 0.75rem; padding: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 600; color: ${actionColor};">${actionLabel}</span>
                                    <span style="color: var(--text-tertiary); font-size: 12px;">‚Ä¢</span>
                                    <span style="color: var(--text-secondary); font-size: 13px;">${log.username}</span>
                                    <span style="color: var(--text-tertiary); font-size: 12px;">‚Ä¢</span>
                                    <span style="color: var(--text-tertiary); font-size: 12px;">${log.resource_type}</span>
                                </div>
                                ${log.resource_name ? `<div style="color: var(--text-secondary); font-size: 13px; margin-bottom: 0.25rem;">${log.resource_name}</div>` : ''}
                                ${log.details && Object.keys(log.details).length > 0 ? `<div style="color: var(--text-tertiary); font-size: 12px; font-family: 'Courier New', monospace;">${JSON.stringify(log.details)}</div>` : ''}
                            </div>
                            <div style="text-align: right;">
                                <div style="color: var(--text-tertiary); font-size: 11px;">${timestamp}</div>
                                ${log.ip_address ? `<div style="color: var(--text-tertiary); font-size: 11px; margin-top: 0.25rem;">${log.ip_address}</div>` : ''}
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');
                
                // Update pagination
                document.getElementById('logs-page-info').textContent = `Page ${logsPage + 1}`;
                document.getElementById('logs-prev').disabled = logsPage === 0;
                document.getElementById('logs-next').disabled = data.logs.length < logsPageSize;
            } catch (err) {
                console.error('Failed to load logs:', err);
            }
        }

        function loadLogsPage(direction) {
            logsPage += direction;
            if (logsPage < 0) logsPage = 0;
            loadLogs();
        }

        function getActionColor(action) {
            if (action.includes('success') || action.includes('created')) return 'var(--success)';
            if (action.includes('failed') || action.includes('denied') || action.includes('deleted')) return 'var(--error)';
            if (action.includes('updated') || action.includes('configured')) return 'var(--warning)';
            return 'var(--text-primary)';
        }

        function formatActionLabel(action) {
            return action
                .split('_')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        let providersData = null; // Store providers globally

        async function loadProviders() {
            try {
                const res = await fetch(`${API_BASE}/providers`);
                const data = await res.json();
                providersData = data.providers; // Store for later use
                
                const select = document.getElementById('provider');
                select.innerHTML = '<option value="">Select provider...</option>';
                data.providers.forEach(p => {
                    select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                });
                
                select.addEventListener('change', (e) => {
                    const provider = data.providers.find(p => p.id === e.target.value);
                    if (!provider) {
                        document.getElementById('provider-config').innerHTML = '';
                        return;
                    }
                    
                    let html = '';
                    provider.fields.forEach(f => {
                        // Skip hidden fields in UI but store them
                        if (f.type === 'hidden') {
                            html += `<input type="hidden" name="${f.name}" value="${f.default || ''}">`;
                            return;
                        }
                        
                        html += `<div class="form-group">
                            <label>${f.label}${f.required ? ' *' : ''}</label>`;
                        
                        if (f.type === 'select') {
                            html += `<select name="${f.name}">`;
                            f.options.forEach(opt => {
                                const selected = f.default === opt ? 'selected' : '';
                                html += `<option value="${opt}" ${selected}>${opt}</option>`;
                            });
                            html += `</select>`;
                        } else if (f.type === 'textarea') {
                            html += `<textarea name="${f.name}" placeholder="${f.placeholder || ''}">${f.default || ''}</textarea>`;
                        } else {
                            html += `<input type="${f.type}" name="${f.name}" placeholder="${f.placeholder || ''}" ${f.default ? `value="${f.default}"` : ''}>`;
                        }
                        html += `</div>`;
                    });
                    
                    document.getElementById('provider-config').innerHTML = html;
                });
            } catch (err) {
                console.error('Failed to load providers:', err);
            }
        }

        async function loadRemotes() {
            try {
                const res = await fetch(`${API_BASE}/remotes`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                const sourceSelect = document.getElementById('source-remote');
                const destSelect = document.getElementById('dest-remote');
                
                sourceSelect.innerHTML = '<option value="">Select remote...</option>';
                destSelect.innerHTML = '<option value="">Select remote...</option>';
                
                // Populate Tests & Queries dropdowns
                const testSourceSelect = document.getElementById('test-source-remote');
                const testDestSelect = document.getElementById('test-dest-remote');
                const queryRemoteSelect = document.getElementById('query-remote');
                
                if (testSourceSelect) testSourceSelect.innerHTML = '<option value="">Select remote...</option>';
                if (testDestSelect) testDestSelect.innerHTML = '<option value="">Select remote...</option>';
                if (queryRemoteSelect) queryRemoteSelect.innerHTML = '<option value="">Select remote...</option>';
                
                // Populate Decrypt dropdowns
                const decryptSourceSelect = document.getElementById('decrypt-source-remote');
                const decryptDestSelect = document.getElementById('decrypt-dest-remote');
                
                if (decryptSourceSelect) decryptSourceSelect.innerHTML = '<option value="">Select remote with encrypted files...</option>';
                if (decryptDestSelect) decryptDestSelect.innerHTML = '<option value="">Select destination for decrypted files...</option>';
                
                data.remotes.forEach(remote => {
                    const option = `<option value="${remote.name}">${remote.name} (${remote.type})</option>`;
                    sourceSelect.innerHTML += option;
                    destSelect.innerHTML += option;
                    if (testSourceSelect) testSourceSelect.innerHTML += option;
                    if (testDestSelect) testDestSelect.innerHTML += option;
                    if (queryRemoteSelect) queryRemoteSelect.innerHTML += option;
                    if (decryptSourceSelect) decryptSourceSelect.innerHTML += option;
                    if (decryptDestSelect) decryptDestSelect.innerHTML += option;
                });
                
                // Update remotes list
                const list = document.getElementById('remotes-list');
                if (data.remotes.length === 0) {
                    list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚òÅÔ∏è</div><p>No remotes configured yet</p></div>';
                } else {
                    list.innerHTML = data.remotes.map(r => `
                        <div class="remote-item">
                            <div class="remote-info">
                                <h4>${r.name}</h4>
                                <p>${r.type} ‚Ä¢ Added ${new Date(r.created_at).toLocaleDateString()}</p>
                            </div>
                            <div class="remote-actions">
                                <button class="btn btn-secondary btn-small" onclick="testRemote(${r.id})">Test</button>
                                <button class="btn btn-danger btn-small" onclick="deleteRemote(${r.id}, '${r.name}')">Delete</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Failed to load remotes:', err);
            }
        }

        async function addRemote() {
            const name = document.getElementById('remote-name').value;
            const providerId = document.getElementById('provider').value;
            
            if (!name || !providerId) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Find the selected provider to get its actual type
            const selectedProvider = providersData.find(p => p.id === providerId);
            if (!selectedProvider) {
                alert('Invalid provider selected');
                return;
            }
            
            const type = selectedProvider.type; // Get the actual rclone type
            
            const config = {};
            document.querySelectorAll('#provider-config input, #provider-config select, #provider-config textarea').forEach(input => {
                if (input.value) config[input.name] = input.value;
            });
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Validating connection...';
            
            try {
                console.log('[addRemote] Creating remote:', { name, type, providerId, config });
                
                const response = await fetch(`${API_BASE}/remotes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ name, type, config })
                });
                
                console.log('[addRemote] Response status:', response.status);
                const data = await response.json();
                console.log('[addRemote] Response data:', data);
                
                if (response.ok) {
                    document.getElementById('remote-name').value = '';
                    document.getElementById('provider').value = '';
                    document.getElementById('provider-config').innerHTML = '';
                    loadRemotes();
                    alert(data.message || 'SUCCESS: Remote added successfully!');
                } else {
                    let errorMsg = 'ERROR: Failed to add remote\n\n';
                    
                    if (response.status === 403) {
                        errorMsg += 'Permission Denied: You do not have permission to manage remotes.\n\nContact an administrator to upgrade your role to Power User or Admin.';
                    } else {
                        errorMsg += (data.error || 'Unknown error');
                        if (data.details) errorMsg += '\n\nDetails: ' + data.details;
                    }
                    
                    alert(errorMsg);
                }
            } catch (err) {
                console.error('[addRemote] Fetch error:', err);
                
                let errorMsg = 'ERROR: Connection Error\n\n';
                
                if (err.message === 'Failed to fetch') {
                    errorMsg += 'Cannot connect to server. Possible causes:\n\n';
                    errorMsg += '‚Ä¢ Backend container not running\n';
                    errorMsg += '‚Ä¢ Network connection interrupted\n';
                    errorMsg += '‚Ä¢ Browser blocked the request\n\n';
                    errorMsg += 'Check: sudo docker-compose ps';
                } else {
                    errorMsg += err.message;
                }
                
                alert(errorMsg);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function deleteRemote(id, name) {
            if (!confirm(`Delete remote "${name}"? This cannot be undone.`)) return;
            
            try {
                await fetch(`${API_BASE}/remotes/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadRemotes();
            } catch (err) {
                alert('Failed to delete remote');
            }
        }

        async function testRemote(id) {
            try {
                const res = await fetch(`${API_BASE}/remotes/${id}/test`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                alert(data.success ? 'SUCCESS: Connection successful!' : 'ERROR: ' + data.error);
            } catch (err) {
                alert('Test failed');
            }
        }

        async function loadTransfers() {
            try {
                const res = await fetch(`${API_BASE}/transfers`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                const list = document.getElementById('transfers-list');
                if (data.transfers.length === 0) {
                    list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¶</div><p>No active transfers</p></div>';
                    return;
                }
                
                list.innerHTML = data.transfers.map(t => {
                    // Check if user can delete this transfer
                    const canDelete = userPermissions && (userPermissions.can_delete_any_transfers || userPermissions.can_delete_own_transfers);
                    
                    return `
                    <div class="transfer-item">
                        <div class="transfer-header">
                            <span class="transfer-status ${t.status}">${t.status}</span>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <span style="color: var(--text-tertiary); font-size: 12px; text-transform: uppercase;">${t.operation}</span>
                                ${t.status === 'running' || t.status === 'queued' ? `
                                    <button class="btn btn-danger btn-small" onclick="cancelTransfer('${t.transfer_id}')">Cancel</button>
                                ` : ''}
                                ${(t.status === 'failed' || t.status === 'completed') && canDelete ? `
                                    <button class="btn btn-secondary btn-small" onclick="deleteTransfer('${t.transfer_id}')">Delete</button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="transfer-path">
                            <span>${t.source_remote}:${t.source_path}</span>
                            <span class="transfer-arrow">‚Üí</span>
                            <span>${t.dest_remote}:${t.dest_path}</span>
                        </div>
                        ${t.schedule_type ? `
                            <div style="margin-top: 0.75rem; padding: 0.5rem; background: rgba(255, 107, 53, 0.1); border-radius: 6px; font-size: 12px;">
                                <strong> Scheduled:</strong> ${t.schedule_type === 'once' ? 'One-time' : t.schedule_interval} 
                                ${t.next_run ? '‚Ä¢ Next run: ' + new Date(t.next_run).toLocaleString() : ''}
                            </div>
                        ` : ''}
                        ${(t.status === 'running' || t.status === 'queued') && t.progress ? `
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${t.progress.percentage || 0}%"></div>
                            </div>
                            <div class="transfer-stats">
                                <span><strong>${t.progress.transferred || '0 B'}</strong> transferred</span>
                                <span>${t.progress.speed || '0 B/s'}</span>
                                <span>ETA: ${t.progress.eta || 'calculating...'}</span>
                                <span>${t.progress.percentage ? t.progress.percentage + '% complete' : 'calculating...'}</span>
                            </div>
                        ` : ''}
                        ${t.error ? `<div class="transfer-error" style="${t.status === 'completed' ? 'background: rgba(16, 185, 129, 0.1); color: var(--success); border-color: var(--success);' : ''}">${t.error}</div>` : ''}
                    </div>
                `}).join('');
            } catch (err) {
                console.error('Failed to load transfers:', err);
            }
        }

        async function loadHistory() {
            try {
                const status = document.getElementById('history-filter')?.value || '';
                const res = await fetch(`${API_BASE}/transfers/history?status=${status}&limit=50`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                // Update stats
                if (data.statistics) {
                    document.getElementById('stat-total').textContent = data.statistics.total;
                    document.getElementById('stat-completed').textContent = data.statistics.completed;
                    document.getElementById('stat-failed').textContent = data.statistics.failed;
                    document.getElementById('stat-running').textContent = data.statistics.running;
                }
                
                const list = document.getElementById('history-list');
                if (data.transfers.length === 0) {
                    list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><p>No transfer history</p></div>';
                    return;
                }
                
                list.innerHTML = data.transfers.map(t => `
                    <div class="transfer-item">
                        <div class="transfer-header">
                            <span class="transfer-status ${t.status}">${t.status}</span>
                            <span style="color: var(--text-tertiary); font-size: 11px;">
                                ${new Date(t.created_at).toLocaleString()}
                            </span>
                        </div>
                        <div class="transfer-path">
                            <span>${t.source_remote}:${t.source_path}</span>
                            <span class="transfer-arrow">‚Üí</span>
                            <span>${t.dest_remote}:${t.dest_path}</span>
                        </div>
                        ${t.progress && t.progress.transferred ? `
                            <div style="margin-top: 0.75rem; font-size: 13px; color: var(--text-secondary);">
                                Transferred: <strong style="color: var(--text-primary);">${t.progress.transferred}</strong>
                            </div>
                        ` : ''}
                        ${t.error ? `<div class="transfer-error" style="${t.status === 'completed' ? 'background: rgba(16, 185, 129, 0.1); color: var(--success); border-color: var(--success);' : ''}">${t.error}</div>` : ''}
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load history:', err);
            }
        }

        async function loadScheduled() {
            try {
                const filter = document.getElementById('scheduled-filter')?.value || '';
                const res = await fetch(`${API_BASE}/transfers/scheduled?filter=${filter}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                // Update stats
                if (data.statistics) {
                    document.getElementById('stat-scheduled-total').textContent = data.statistics.total;
                    document.getElementById('stat-scheduled-active').textContent = data.statistics.active;
                    document.getElementById('stat-scheduled-disabled').textContent = data.statistics.disabled;
                    document.getElementById('stat-scheduled-recurring').textContent = data.statistics.recurring;
                }
                
                const list = document.getElementById('scheduled-list');
                if (data.transfers.length === 0) {
                    list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚è∞</div><p>No scheduled jobs</p><small style="color: var(--text-tertiary);">Schedule transfers from the Transfers tab</small></div>';
                    return;
                }
                
                list.innerHTML = data.transfers.map(t => {
                    const nextRun = t.next_run ? new Date(t.next_run).toLocaleString() : 'Not scheduled';
                    const lastRun = t.last_run ? new Date(t.last_run).toLocaleString() : 'Never';
                    const scheduleType = t.schedule_type === 'recurring' ? `Recurring (${t.schedule_interval})` : 'One-time';
                    
                    // Check if user can delete
                    const canDelete = userPermissions && (userPermissions.can_delete_any_transfers || userPermissions.can_delete_own_transfers);
                    
                    return `
                    <div class="card" style="margin-bottom: 1rem;">
                        <div class="transfer-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div>
                                <span class="transfer-status ${t.enabled ? 'queued' : 'failed'}" style="margin-right: 0.5rem;">${t.enabled ? 'ACTIVE' : 'DISABLED'}</span>
                                <span style="color: var(--text-tertiary); font-size: 11px;">${scheduleType}</span>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-secondary btn-small" onclick='editScheduledJob(${JSON.stringify(t).replace(/'/g, "\\'")})'> Edit</button>
                                <button class="btn btn-${t.enabled ? 'secondary' : 'primary'} btn-small" onclick="toggleScheduledJob(${t.id}, ${!t.enabled})">
                                    ${t.enabled ? 'Disable' : 'Enable'}
                                </button>
                                ${canDelete ? `<button class="btn btn-danger btn-small" onclick="deleteScheduledJob(${t.id})">Delete</button>` : ''}
                            </div>
                        </div>
                        <div class="transfer-path">
                            <span>${t.source_remote}:${t.source_path}</span>
                            <span class="transfer-arrow">‚Üí</span>
                            <span>${t.dest_remote}:${t.dest_path}</span>
                        </div>
                        <div style="margin-top: 1rem; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; font-size: 13px;">
                            <div>
                                <div style="color: var(--text-tertiary);">Operation</div>
                                <div style="margin-top: 0.25rem; font-weight: 500;">${t.operation}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-tertiary);">Next Run</div>
                                <div style="margin-top: 0.25rem; font-weight: 500; color: var(--accent-orange);">${nextRun}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-tertiary);">Last Run</div>
                                <div style="margin-top: 0.25rem; font-weight: 500;">${lastRun}</div>
                            </div>
                        </div>
                    </div>
                `}).join('');
            } catch (err) {
                console.error('Failed to load scheduled jobs:', err);
            }
        }

        async function startTransfer() {
            const operation = document.getElementById('operation').value;
            const sourceRemote = document.getElementById('source-remote').value;
            const sourcePath = document.getElementById('source-path').value;
            const destRemote = document.getElementById('dest-remote').value;
            const destPath = document.getElementById('dest-path').value;
            
            if (!sourceRemote || !destRemote) {
                alert('Please select source and destination remotes');
                return;
            }
            
            // Check for egress warning (only for cloud providers with egress charges)
            const sourceRemoteData = providersData ? await getRemoteInfo(sourceRemote) : null;
            const hasEgressCharges = sourceRemoteData && ['s3', 'google cloud storage', 'azureblob'].includes(sourceRemoteData.type);
            
            // Show egress warning for providers that charge for downloads
            if (hasEgressCharges && !sessionStorage.getItem(`egress_warning_dismissed_${sourceRemote}`)) {
                if (!confirm('‚ö†Ô∏è EGRESS COST WARNING\n\nYou are transferring data FROM a cloud provider that charges for data egress (downloads).\n\nProviders like Amazon S3, Google Cloud Storage, and Azure Blob Storage typically charge fees for downloading data out of their platforms. These costs can add up quickly with large transfers.\n\nNote: Cloudflare R2 and Backblaze B2 do NOT charge egress fees.\n\nRefer to your cloud provider\'s pricing documentation for current rates.\n\nClick OK to continue or Cancel to abort this transfer.')) {
                    return;
                }
                // Remember dismissal for this session
                sessionStorage.setItem(`egress_warning_dismissed_${sourceRemote}`, 'true');
            }
            
            // Build schedule object if enabled
            let schedule = null;
            if (document.getElementById('schedule-enabled').checked) {
                const type = document.getElementById('schedule-type').value;
                schedule = {
                    enabled: true,
                    type: type
                };
                
                if (type === 'once') {
                    const datetime = document.getElementById('schedule-datetime').value;
                    if (!datetime) {
                        alert('Please select a date and time for the scheduled transfer');
                        return;
                    }
                    schedule.datetime = datetime;
                } else if (type === 'recurring') {
                    schedule.interval = document.getElementById('schedule-interval').value;
                    schedule.time = document.getElementById('schedule-time').value;
                    // Send timezone offset so backend can calculate correct time
                    schedule.timezoneOffset = new Date().getTimezoneOffset();
                }
            }
            
            // Build encryption object if enabled
            let encryption = null;
            if (document.getElementById('encrypt-enabled').checked) {
                const password = document.getElementById('encrypt-password').value;
                const confirmPassword = document.getElementById('encrypt-password-confirm').value;
                
                // If password provided, validate it
                if (password || confirmPassword) {
                    if (password !== confirmPassword) {
                        alert('Encryption passwords do not match!');
                        return;
                    }
                    if (password.length < 8) {
                        alert('Encryption password must be at least 8 characters long');
                        return;
                    }
                    encryption = {
                        enabled: true,
                        password: password
                    };
                } else {
                    // Auto-generate password
                    encryption = {
                        enabled: true,
                        password: null // Backend will generate
                    };
                }
            }
            
            try {
                const response = await fetch(`${API_BASE}/transfers`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        operation,
                        sourceRemote,
                        sourcePath,
                        destRemote,
                        destPath,
                        schedule,
                        encryption
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Reset form
                    document.getElementById('schedule-enabled').checked = false;
                    document.getElementById('encrypt-enabled').checked = false;
                    toggleSchedule();
                    toggleEncryption();
                    
                    loadTransfers();
                    
                    // Show encryption password if generated
                    if (encryption && encryption.enabled && data.encryption_password) {
                        alert(`SUCCESS: Transfer created!\n\nüîí ENCRYPTION PASSWORD (SAVE THIS!):\n${data.encryption_password}\n\nYou will need this password to decrypt your files later.`);
                    } else if (schedule && schedule.enabled) {
                        alert(`SUCCESS: Transfer scheduled successfully! ${schedule.type === 'once' ? 'Will run at specified time.' : 'Will run ' + schedule.interval + '.'}`);
                    }
                } else {
                    // Show user-friendly error messages
                    if (response.status === 403) {
                        if (data.error && data.error.includes('Sync operations')) {
                            alert('ERROR: Permission Denied\n\nYou do not have permission to create sync transfers. Your role only allows copy operations.\n\nPlease select "copy" as the operation type or contact an administrator to upgrade your permissions.');
                        } else {
                            alert('ERROR: Permission Denied\n\n' + (data.error || 'You do not have permission to perform this action.'));
                        }
                    } else {
                        alert('ERROR: Failed to create transfer: ' + (data.error || 'Unknown error'));
                    }
                }
            } catch (err) {
                alert('ERROR: Failed to start transfer: ' + err.message);
            }
        }
        
        // Helper function to get remote info
        async function getRemoteInfo(remoteName) {
            try {
                const res = await fetch(`${API_BASE}/remotes`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                return data.remotes.find(r => r.name === remoteName);
            } catch (err) {
                console.error('Failed to get remote info:', err);
                return null;
            }
        }
        
        async function cancelTransfer(id) {
            if (!confirm('Cancel this transfer? If running, it will be stopped immediately.')) return;
            
            try {
                await fetch(`${API_BASE}/transfers/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadTransfers();
                loadHistory();
            } catch (err) {
                alert('Failed to cancel transfer');
            }
        }
        
        async function deleteTransfer(id) {
            if (!confirm('Delete this transfer record?')) return;
            
            try {
                await fetch(`${API_BASE}/transfers/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadTransfers();
                loadHistory();
            } catch (err) {
                alert('Failed to delete transfer');
            }
        }
        
        // ==================== DECRYPTION FUNCTIONS ====================
        
        async function startDecryption() {
            const sourceRemote = document.getElementById('decrypt-source-remote').value;
            const sourcePath = document.getElementById('decrypt-source-path').value || '';
            const password = document.getElementById('decrypt-password').value;
            const destRemote = document.getElementById('decrypt-dest-remote').value;
            const destPath = document.getElementById('decrypt-dest-path').value || '';
            
            if (!sourceRemote || !destRemote) {
                alert('Please select source and destination remotes');
                return;
            }
            
            if (!password) {
                alert('Please enter the decryption password');
                return;
            }
            
            if (!confirm(`Start decryption?\n\nEncrypted files from:\n${sourceRemote}:${sourcePath || '/'}\n\nWill be decrypted to:\n${destRemote}:${destPath || '/'}\n\nThis will create a new transfer.`)) {
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/decrypt`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        sourceRemote,
                        sourcePath,
                        password,
                        destRemote,
                        destPath
                    })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    alert(`SUCCESS: Decryption started!\n\nTransfer ID: ${data.transfer_id}\n\nCheck "Active Transfers" below to monitor progress.`);
                    
                    // Clear password field for security
                    document.getElementById('decrypt-password').value = '';
                    
                    // Reload transfers to show new decryption transfer
                    loadTransfers();
                } else {
                    alert('ERROR: ' + (data.error || 'Failed to start decryption'));
                }
            } catch (err) {
                alert('ERROR: ' + err.message);
            }
        }
        
        async function testDecryptPassword() {
            const sourceRemote = document.getElementById('decrypt-source-remote').value;
            const sourcePath = document.getElementById('decrypt-source-path').value || '';
            const password = document.getElementById('decrypt-password').value;
            
            if (!sourceRemote) {
                alert('Please select source remote');
                return;
            }
            
            if (!password) {
                alert('Please enter password to test');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/decrypt/test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        sourceRemote,
                        sourcePath,
                        password
                    })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    if (data.success) {
                        alert(`‚úì Password Test PASSED!\n\nThis password can decrypt files from:\n${sourceRemote}:${sourcePath || '/'}\n\nFiles found: ${data.file_count || 'multiple'}`);
                    } else {
                        alert(`‚úó Password Test FAILED\n\n${data.error || 'Cannot decrypt with this password'}\n\nMake sure:\n‚Ä¢ Password is correct\n‚Ä¢ Source path contains encrypted files\n‚Ä¢ Files were encrypted with this password`);
                    }
                } else {
                    alert('ERROR: ' + (data.error || 'Failed to test password'));
                }
            } catch (err) {
                alert('ERROR: ' + err.message);
            }
        }
        
        // Tests & Queries Functions
        async function runDryRun() {
            const operation = document.getElementById('test-operation').value;
            const sourceRemote = document.getElementById('test-source-remote').value;
            const sourcePath = document.getElementById('test-source-path').value;
            const destRemote = document.getElementById('test-dest-remote').value;
            const destPath = document.getElementById('test-dest-path').value;
            
            if (!sourceRemote || !destRemote) {
                alert('Please select source and destination remotes');
                return;
            }
            
            const outputDiv = document.getElementById('dry-run-output');
            const resultsDiv = document.getElementById('dry-run-results');
            
            outputDiv.style.display = 'block';
            resultsDiv.textContent = 'Running dry-run test...\n\nThis may take a moment depending on the number of files.\n';
            
            try {
                const response = await fetch(`${API_BASE}/tests/dry-run`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        operation,
                        sourceRemote,
                        sourcePath,
                        destRemote,
                        destPath
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultsDiv.textContent = data.output || 'Dry-run completed successfully!\n\n' + (data.summary || 'No changes detected.');
                } else {
                    resultsDiv.textContent = 'ERROR: ' + (data.error || 'Failed to run dry-run test');
                }
            } catch (err) {
                resultsDiv.textContent = 'ERROR: ' + err.message;
            }
        }
        
        async function runQuery() {
            const remote = document.getElementById('query-remote').value;
            const path = document.getElementById('query-path').value;
            const command = document.getElementById('query-command').value;
            const filename = document.getElementById('query-filename').value;
            
            if (!remote) {
                alert('Please select a remote');
                return;
            }
            
            if (command === 'cat' && !filename) {
                alert('Please enter a filename for the cat command');
                return;
            }
            
            const outputDiv = document.getElementById('query-output');
            const resultsDiv = document.getElementById('query-results');
            
            outputDiv.style.display = 'block';
            resultsDiv.textContent = 'Running query...\n';
            
            try {
                const response = await fetch(`${API_BASE}/tests/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        remote,
                        path,
                        command,
                        filename
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultsDiv.textContent = data.output || 'Query completed successfully!';
                } else {
                    resultsDiv.textContent = 'ERROR: ' + (data.error || 'Failed to run query');
                }
            } catch (err) {
                resultsDiv.textContent = 'ERROR: ' + err.message;
            }
        }
        
        // ==================== ADMIN SHELL FUNCTIONS ====================
        
        let shellHistory = [];
        
        async function runShellCommand() {
            const commandInput = document.getElementById('shell-command');
            const command = commandInput.value.trim();
            
            if (!command) {
                alert('Please enter a command');
                return;
            }
            
            // Show output div
            const outputDiv = document.getElementById('shell-output');
            outputDiv.style.display = 'block';
            
            // Add command to output
            const timestamp = new Date().toLocaleTimeString();
            outputDiv.textContent += `\n[${timestamp}] $ ${command}\n`;
            
            // Scroll to bottom
            outputDiv.scrollTop = outputDiv.scrollHeight;
            
            try {
                const res = await fetch(`${API_BASE}/admin/shell`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ command })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    // Display output
                    outputDiv.textContent += data.output || '(no output)\n';
                    
                    // Add to history
                    shellHistory.push({
                        command,
                        timestamp,
                        output: data.output,
                        exit_code: data.exit_code
                    });
                    
                    // Update history display
                    updateShellHistory();
                    
                    // Clear input
                    commandInput.value = '';
                } else {
                    outputDiv.textContent += `ERROR: ${data.error || 'Command failed'}\n`;
                }
                
                // Scroll to bottom
                outputDiv.scrollTop = outputDiv.scrollHeight;
            } catch (err) {
                outputDiv.textContent += `ERROR: ${err.message}\n`;
                outputDiv.scrollTop = outputDiv.scrollHeight;
            }
        }
        
        function clearShellOutput() {
            const outputDiv = document.getElementById('shell-output');
            outputDiv.textContent = '';
            outputDiv.style.display = 'none';
            shellHistory = [];
            updateShellHistory();
        }
        
        function updateShellHistory() {
            const historyDiv = document.getElementById('shell-history');
            const historyList = document.getElementById('shell-history-list');
            
            if (shellHistory.length === 0) {
                historyDiv.style.display = 'none';
                return;
            }
            
            historyDiv.style.display = 'block';
            historyList.innerHTML = shellHistory.slice(-10).reverse().map((item, i) => `
                <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px;">
                    <div style="color: var(--text-secondary);">[${item.timestamp}] <code>${item.command}</code></div>
                    <div style="color: ${item.exit_code === 0 ? '#4CAF50' : '#f44336'}; font-size: 11px;">Exit code: ${item.exit_code}</div>
                </div>
            `).join('');
        }
        
        // ==================== DECRYPTION FUNCTIONS ====================
        
        async function startDecryption() {
            const sourceRemote = document.getElementById('decrypt-source-remote').value;
            const sourcePath = document.getElementById('decrypt-source-path').value;
            const password = document.getElementById('decrypt-password').value;
            const destRemote = document.getElementById('decrypt-dest-remote').value;
            const destPath = document.getElementById('decrypt-dest-path').value;
            
            if (!sourceRemote || !destRemote) {
                alert('Please select source and destination remotes');
                return;
            }
            
            if (!password) {
                alert('Please enter the decryption password');
                return;
            }
            
            if (!confirm('Start decryption?\n\nThis will create a transfer to decrypt your files from:\n' + 
                        sourceRemote + ':' + (sourcePath || '/') + '\n\nto:\n' + 
                        destRemote + ':' + (destPath || '/'))) {
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/decrypt`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        sourceRemote,
                        sourcePath,
                        password,
                        destRemote,
                        destPath
                    })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    // Show progress card
                    const progressCard = document.getElementById('decrypt-progress-card');
                    const progressContent = document.getElementById('decrypt-progress-content');
                    
                    progressCard.style.display = 'block';
                    progressContent.innerHTML = `
                        <div style="padding: 1rem;">
                            <div style="margin-bottom: 1rem;">
                                <strong>Decryption Started</strong>
                                <p style="margin: 0.5rem 0; color: var(--text-secondary); font-size: 13px;">
                                    Transfer ID: ${data.transfer_id}
                                </p>
                            </div>
                            <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; font-family: 'Monaco', monospace; font-size: 12px;">
                                Decrypting: ${sourceRemote}:${sourcePath || '/'}<br>
                                To: ${destRemote}:${destPath || '/'}<br>
                                Status: <span style="color: var(--warning);">In Progress...</span>
                            </div>
                            <p style="margin-top: 1rem; font-size: 13px; color: var(--text-secondary);">
                                Switch to the "Transfers" tab to monitor progress. Decrypted files will appear in your destination.
                            </p>
                        </div>
                    `;
                    
                    // Clear form
                    document.getElementById('decrypt-password').value = '';
                    
                    // Refresh history
                    setTimeout(() => loadDecryptionHistory(), 1000);
                    
                    alert('SUCCESS: Decryption transfer started!\n\nCheck the Transfers tab to monitor progress.');
                } else {
                    alert('ERROR: ' + (data.error || 'Failed to start decryption'));
                }
            } catch (err) {
                alert('ERROR: ' + err.message);
            }
        }
        
        async function testDecryptPassword() {
            const sourceRemote = document.getElementById('decrypt-source-remote').value;
            const sourcePath = document.getElementById('decrypt-source-path').value;
            const password = document.getElementById('decrypt-password').value;
            
            if (!sourceRemote) {
                alert('Please select a source remote');
                return;
            }
            
            if (!password) {
                alert('Please enter a password to test');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/decrypt/test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        sourceRemote,
                        sourcePath,
                        password
                    })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    if (data.success) {
                        alert('‚úì Password Test Successful!\n\nThis password can decrypt files from this location.\n\nFiles found: ' + data.file_count);
                    } else {
                        alert('‚úó Password Test Failed\n\n' + (data.error || 'Unable to decrypt with this password'));
                    }
                } else {
                    alert('ERROR: ' + (data.error || 'Failed to test password'));
                }
            } catch (err) {
                alert('ERROR: ' + err.message);
            }
        }
        
        async function loadDecryptionHistory() {
            try {
                const res = await fetch(`${API_BASE}/decrypt/history`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                const container = document.getElementById('decrypt-history-list');
                
                if (!data.history || data.history.length === 0) {
                    container.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-tertiary);">No decryption history yet</div>';
                    return;
                }
                
                container.innerHTML = data.history.map(item => `
                    <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem;">
                                    üîì ${item.source_remote}:${item.source_path || '/'} ‚Üí ${item.dest_remote}:${item.dest_path || '/'}
                                </div>
                                <div style="font-size: 13px; color: var(--text-secondary);">
                                    Started: ${new Date(item.created_at).toLocaleString()}
                                    ${item.completed_at ? ' ‚Ä¢ Completed: ' + new Date(item.completed_at).toLocaleString() : ''}
                                </div>
                            </div>
                            <div>
                                <span style="padding: 0.25rem 0.75rem; background: ${item.status === 'completed' ? 'rgba(76, 175, 80, 0.2)' : item.status === 'failed' ? 'rgba(244, 67, 54, 0.2)' : 'rgba(255, 152, 0, 0.2)'}; color: ${item.status === 'completed' ? '#4CAF50' : item.status === 'failed' ? '#f44336' : '#FF9800'}; border-radius: 4px; font-size: 11px; text-transform: uppercase;">
                                    ${item.status}
                                </span>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load decryption history:', err);
            }
        }
        
        // Show/hide filename input for cat command
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize theme
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const btn = document.getElementById('theme-toggle-btn');
            if (btn) {
                btn.textContent = savedTheme === 'light' ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
            }
            
            const queryCommand = document.getElementById('query-command');
            const queryFileInput = document.getElementById('query-file-input');
            
            if (queryCommand && queryFileInput) {
                queryCommand.addEventListener('change', (e) => {
                    if (e.target.value === 'cat') {
                        queryFileInput.style.display = 'block';
                    } else {
                        queryFileInput.style.display = 'none';
                    }
                });
            }
        });

        async function loadSettings() {
            try {
                const res = await fetch(`${API_BASE}/notifications/settings`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (data.settings) {
                    const s = data.settings;
                    document.getElementById('email-enabled').checked = s.email_enabled;
                    document.getElementById('email-address').value = s.email_address || '';
                    document.getElementById('from-email').value = s.from_email || '';
                    document.getElementById('smtp-host').value = s.smtp_host || '';
                    document.getElementById('smtp-port').value = s.smtp_port || 587;
                    document.getElementById('smtp-user').value = s.smtp_user || '';
                    document.getElementById('smtp-pass').value = s.smtp_pass || '';
                    document.getElementById('webhook-enabled').checked = s.webhook_enabled || false;
                    document.getElementById('webhook-url').value = s.webhook_url || '';
                    document.getElementById('webhook-type').value = s.webhook_type || 'slack';
                    
                    // Timezone
                    document.getElementById('timezone').value = s.timezone || 'UTC';
                    
                    // Email notification preferences
                    document.getElementById('notify-failure').checked = s.notify_on_failure !== false;
                    document.getElementById('notify-success').checked = s.notify_on_success || false;
                    document.getElementById('daily-report').checked = s.daily_report || false;
                    
                    // Webhook notification preferences
                    document.getElementById('webhook-notify-failure').checked = s.webhook_notify_on_failure !== false;
                    document.getElementById('webhook-notify-success').checked = s.webhook_notify_on_success || false;
                    document.getElementById('webhook-daily-report').checked = s.webhook_daily_report || false;
                }
            } catch (err) {
                console.error('Failed to load settings:', err);
            }
        }

        async function saveSettings() {
            try {
                const settings = {
                    email_enabled: document.getElementById('email-enabled').checked,
                    email_address: document.getElementById('email-address').value,
                    from_email: document.getElementById('from-email').value,
                    smtp_host: document.getElementById('smtp-host').value,
                    smtp_port: parseInt(document.getElementById('smtp-port').value),
                    smtp_user: document.getElementById('smtp-user').value,
                    smtp_pass: document.getElementById('smtp-pass').value,
                    webhook_enabled: document.getElementById('webhook-enabled').checked,
                    webhook_url: document.getElementById('webhook-url').value,
                    webhook_type: document.getElementById('webhook-type').value,
                    timezone: document.getElementById('timezone').value,
                    notify_on_failure: document.getElementById('notify-failure').checked,
                    notify_on_success: document.getElementById('notify-success').checked,
                    daily_report: document.getElementById('daily-report').checked,
                    webhook_notify_on_failure: document.getElementById('webhook-notify-failure').checked,
                    webhook_notify_on_success: document.getElementById('webhook-notify-success').checked,
                    webhook_daily_report: document.getElementById('webhook-daily-report').checked
                };
                
                await fetch(`${API_BASE}/notifications/settings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(settings)
                });
                
                alert('SUCCESS: Settings saved successfully!');
            } catch (err) {
                alert('ERROR: Failed to save settings');
            }
        }

        async function testEmail() {
            try {
                const res = await fetch(`${API_BASE}/notifications/test`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (res.ok) {
                    alert('SUCCESS: Test email sent! Check your inbox.');
                } else {
                    alert('ERROR: ' + data.error);
                }
            } catch (err) {
                alert('ERROR: Failed to send test email');
            }
        }
        
        async function testWebhook() {
            try {
                const res = await fetch(`${API_BASE}/notifications/test-webhook`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({
                        webhook_url: document.getElementById('webhook-url').value,
                        webhook_type: document.getElementById('webhook-type').value
                    })
                });
                const data = await res.json();
                
                if (res.ok) {
                    alert('SUCCESS: Test webhook sent successfully!');
                } else {
                    alert('ERROR: ' + data.error);
                }
            } catch (err) {
                alert('ERROR: Failed to send test webhook');
            }
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type && data.type.includes('transfer')) {
                    loadTransfers();
                    if (currentTab === 'history') loadHistory();
                }
            };
            
            ws.onclose = () => {
                setTimeout(connectWebSocket, 5000);
            };
        }

        // Allow Enter key to submit login
        document.getElementById('password')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });
    </script>
</body>
</html>
